<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQ群抽奖系统（含奖品初始状态与重置）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        secondary: '#64748B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .prize-card {
                @apply bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none;
            }
            .btn-warning {
                @apply bg-warning hover:bg-warning/90 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/90 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none;
            }
            .btn-disabled {
                @apply bg-gray-300 text-gray-500 cursor-not-allowed py-2 px-4 rounded-lg font-bold;
            }
            .input-field {
                @apply w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-300 outline-none;
            }
            .badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
            }
            .badge-out {
                @apply bg-danger/10 text-danger;
            }
            .badge-initial {
                @apply bg-success/10 text-success;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 加载动画 -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-xl font-bold text-gray-800">QQ群抽奖系统加载中...</p>
    </div>

    <!-- 顶部导航 -->
    <nav class="bg-white shadow-md fixed w-full top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-gift text-2xl text-primary mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">QQ群抽奖系统</h1>
                </div>
                <div class="flex items-center">
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100">
                            <i class="fas fa-user-circle text-2xl text-gray-600"></i>
                            <span id="user-role" class="font-medium text-gray-700">访客</span>
                            <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                        </button>
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50">
                            <a href="#" id="admin-login" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">管理员登录</a>
                            <a href="#" id="logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16">
        <!-- 系统提示 -->
        <div id="system-alert" class="mb-8 p-4 rounded-lg bg-primary/10 border border-primary/20 hidden">
            <p id="alert-message" class="text-gray-700"></p>
        </div>

        <!-- 管理员视图 -->
        <div id="admin-view" class="hidden">
            <!-- 控制面板 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-primary">
                    <p class="text-gray-500 text-sm">总奖品数</p>
                    <p id="admin-total-prizes" class="text-3xl font-bold text-gray-800">0</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-success">
                    <p class="text-gray-500 text-sm">已抽奖次数</p>
                    <p id="admin-total-draws" class="text-3xl font-bold text-gray-800">0</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-warning">
                    <p class="text-gray-500 text-sm">剩余奖品数</p>
                    <p id="admin-left-prizes" class="text-3xl font-bold text-gray-800">0</p>
                </div>
            </div>

            <!-- 系统设置 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-cog text-primary mr-2"></i>系统设置</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">管理员密码</label>
                        <div class="flex space-x-3">
                            <input type="password" id="admin-pwd" class="input-field" placeholder="修改管理员密码">
                            <button id="save-pwd" class="btn-primary">保存</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">白名单开关</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700">启用白名单验证</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="whitelist-switch" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">白名单用户最大抽奖次数</label>
                        <div class="flex space-x-3">
                            <input type="number" id="whitelist-max-draws" class="input-field" min="1" max="10" value="1" placeholder="设置最大抽奖次数">
                            <button id="save-max-draws" class="btn-primary">保存</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">仅对白名单用户生效，范围：1~10次</p>
                    </div>
                </div>
            </div>

            <!-- 奖品管理（新增“设置初始状态”“重置”按钮） -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-gift text-primary mr-2"></i>奖品管理</h2>
                    <button id="add-prize" class="btn-primary"><i class="fas fa-plus mr-1"></i>添加奖品</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">序号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">奖品名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">总数量</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">剩余数量</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">概率(%)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">初始状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">备注</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody id="prize-table" class="bg-white divide-y divide-gray-200">
                            <!-- 奖品数据动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 白名单管理 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-list text-primary mr-2"></i>白名单管理</h2>
                    <button id="add-whitelist" class="btn-primary"><i class="fas fa-plus mr-1"></i>添加用户</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">序号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">用户名（QQ昵称）</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">已抽奖次数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">添加时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody id="whitelist-table" class="bg-white divide-y divide-gray-200">
                            <!-- 白名单数据动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 抽奖记录 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-history text-primary mr-2"></i>抽奖记录</h2>
                    <div class="flex space-x-3">
                        <button id="export-record" class="btn-primary"><i class="fas fa-download mr-1"></i>导出记录</button>
                        <button id="clear-record" class="btn-danger"><i class="fas fa-trash mr-1"></i>清除记录</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">序号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">用户名（QQ昵称）</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">抽中奖品</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">抽奖时间</th>
                            </tr>
                        </thead>
                        <tbody id="record-table" class="bg-white divide-y divide-gray-200">
                            <!-- 抽奖记录动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 用户视图（默认显示） -->
        <div id="user-view">
            <!-- 用户名输入（顶层拦截，未输入则隐藏抽奖区） -->
            <div id="user-input-form" class="bg-white rounded-xl shadow-lg p-8 mb-8 text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">请输入您的QQ昵称</h2>
                <div class="max-w-md mx-auto">
                    <input type="text" id="user-name" class="input-field mb-6" placeholder="例如：群友小明">
                    <button id="submit-name" class="btn-primary w-full">确认并进入抽奖</button>
                </div>
            </div>

            <!-- 抽奖区域（未输入用户名时隐藏） -->
            <div id="lottery-area" class="hidden">
                <!-- 用户信息 -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">当前用户：<span id="current-user" class="text-primary"></span></h3>
                        <p id="lottery-status" class="text-success font-medium mt-1"></p>
                        <p id="remaining-draws" class="text-gray-600 text-sm mt-1">剩余抽奖次数：<span class="text-primary font-medium">1次</span></p>
                    </div>
                    <button id="reset-user" class="text-primary hover:text-primary/80">切换用户</button>
                </div>

                <!-- 奖品概览 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="prize-card text-center">
                        <i class="fas fa-award text-3xl text-primary mb-3"></i>
                        <h3 class="font-bold text-gray-800 mb-1">总奖品数</h3>
                        <p id="user-total-prizes" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="prize-card text-center">
                        <i class="fas fa-ticket-alt text-3xl text-success mb-3"></i>
                        <h3 class="font-bold text-gray-800 mb-1">已抽奖次数</h3>
                        <p id="user-total-draws" class="text-2xl font-bold text-success">0</p>
                    </div>
                    <div class="prize-card text-center">
                        <i class="fas fa-box-open text-3xl text-warning mb-3"></i>
                        <h3 class="font-bold text-gray-800 mb-1">剩余奖品数</h3>
                        <p id="user-left-prizes" class="text-2xl font-bold text-warning">0</p>
                    </div>
                </div>

                <!-- 抽奖按钮 -->
                <div class="text-center mb-12">
                    <button id="start-lottery" class="btn-primary text-xl py-6 px-12">
                        <i class="fas fa-gift mr-3"></i>开始抽奖
                    </button>
                </div>

                <!-- 抽奖结果（默认隐藏） -->
                <div id="lottery-result" class="bg-white rounded-xl shadow-lg p-8 text-center hidden">
                    <div class="w-24 h-24 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-trophy text-primary text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">恭喜您！</h2>
                    <p class="text-lg text-gray-600 mb-6">您抽中了：</p>
                    <div class="bg-gray-50 rounded-lg p-6 mb-8">
                        <h3 id="win-prize" class="text-2xl font-bold text-primary"></h3>
                    </div>
                    <p id="draws-remaining-after" class="text-gray-600 mb-6">剩余抽奖次数：<span class="text-primary font-medium">0次</span></p>
                    <button id="close-result" class="btn-primary">确认</button>
                </div>

                <!-- 奖品列表 -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-list-ul text-primary mr-2"></i>奖品列表</h2>
                    <div id="user-prize-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- 奖品列表动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 管理员登录模态框 -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center"><i class="fas fa-lock text-primary mr-2"></i>管理员登录</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">管理员密码</label>
                    <input type="password" id="login-pwd" class="input-field" placeholder="输入管理员密码">
                </div>
                <p id="login-error" class="text-danger text-sm hidden text-center">密码错误，请重试</p>
                <button id="do-login" class="btn-primary w-full">登录</button>
                <button id="close-login" class="btn-disabled w-full mt-3">取消</button>
            </div>
        </div>
    </div>

    <!-- 添加奖品模态框 -->
    <div id="add-prize-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-gift text-primary mr-2"></i>添加奖品</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">奖品名称 <span class="text-danger">*</span></label>
                    <input type="text" id="new-prize-name" class="input-field" placeholder="输入奖品名称">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">总数量 <span class="text-danger">*</span></label>
                        <input type="number" id="new-prize-num" class="input-field" min="1" value="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">概率(%) <span class="text-danger">*</span></label>
                        <input type="number" id="new-prize-rate" class="input-field" min="0" max="100" step="0.01">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea id="new-prize-remark" class="input-field" rows="2" placeholder="输入奖品备注（选填）"></textarea>
                </div>
                <button id="save-prize" class="btn-primary w-full">保存</button>
                <button id="close-prize-modal" class="btn-disabled w-full mt-3">取消</button>
            </div>
        </div>
    </div>

    <!-- 编辑奖品模态框 -->
    <div id="edit-prize-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-edit text-primary mr-2"></i>编辑奖品</h2>
            <input type="hidden" id="edit-prize-id"> <!-- 存储奖品ID -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">奖品名称 <span class="text-danger">*</span></label>
                    <input type="text" id="edit-prize-name" class="input-field" placeholder="输入奖品名称">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">总数量 <span class="text-danger">*</span></label>
                        <input type="number" id="edit-prize-num" class="input-field" min="1" value="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">剩余数量 <span class="text-danger">*</span></label>
                        <input type="number" id="edit-prize-left" class="input-field" min="0" value="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">概率(%) <span class="text-danger">*</span></label>
                    <input type="number" id="edit-prize-rate" class="input-field" min="0" max="100" step="0.01">
                    <p class="text-xs text-gray-500 mt-1">若剩余数量为0，概率将自动设为0</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea id="edit-prize-remark" class="input-field" rows="2" placeholder="输入奖品备注（选填）"></textarea>
                </div>
                <p id="edit-error" class="text-danger text-sm hidden text-center">数据验证失败，请检查输入</p>
                <button id="update-prize" class="btn-primary w-full">保存修改</button>
                <button id="close-edit-modal" class="btn-disabled w-full mt-3">取消</button>
            </div>
        </div>
    </div>

    <!-- 添加白名单模态框 -->
    <div id="add-whitelist-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-user-plus text-primary mr-2"></i>添加白名单用户</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">用户名（QQ昵称）<span class="text-danger">*</span></label>
                    <input type="text" id="new-whitelist-name" class="input-field" placeholder="输入用户的QQ昵称">
                </div>
                <button id="save-whitelist" class="btn-primary w-full">保存</button>
                <button id="close-whitelist-modal" class="btn-disabled w-full mt-3">取消</button>
            </div>
        </div>
    </div>

    <!-- 清除记录确认模态框 -->
    <div id="clear-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center"><i class="fas fa-exclamation-triangle text-warning mr-2"></i>确认清除记录</h2>
            <p class="text-gray-600 mb-6 text-center">此操作将清除所有抽奖记录，且不可恢复。<br>建议先导出记录备份，确认要继续吗？</p>
            <div class="flex space-x-3">
                <button id="cancel-clear" class="btn-disabled flex-1">取消</button>
                <button id="confirm-clear" class="btn-danger flex-1">确认清除</button>
            </div>
        </div>
    </div>

    <!-- 重置奖品确认模态框 -->
    <div id="reset-prize-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center"><i class="fas fa-exclamation-triangle text-warning mr-2"></i>确认重置奖品</h2>
            <p class="text-gray-600 mb-6 text-center">此操作将把该奖品恢复到初始状态（概率、剩余数量等），确认要继续吗？</p>
            <input type="hidden" id="reset-prize-id"> <!-- 存储要重置的奖品ID -->
            <div class="flex space-x-3">
                <button id="cancel-reset-prize" class="btn-disabled flex-1">取消</button>
                <button id="confirm-reset-prize" class="btn-warning flex-1">确认重置</button>
            </div>
        </div>
    </div>
    <script>
        // 数据存储核心
        const LotteryCore = {
            data: {
                adminPwd: '867678942', // 默认管理员密码
                whitelistEnabled: false,
                settings: {
                    whitelistMaxDraws: 1 // 白名单用户最大抽奖次数，默认1次
                },
                prizes: [
    {
        id: 1768529814293,
        name: "牢大钥匙扣",
        quantity: 1,
        remaining: 1,
        rate: 10.24,
        remark: "Man！哈哈哈",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 10.24,
        initialRemark: "Man！哈哈哈",
        hasInitialState: true
    },
    {
        id: 1768529845172,
        name: "捷风钥匙扣",
        quantity: 1,
        remaining: 1,
        rate: 11.41,
        remark: "颗秒~",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 11.41,
        initialRemark: "颗秒~",
        hasInitialState: true
    },
    {
        id: 1768529924589,
        name: "我以为减速带呢",
        quantity: 1,
        remaining: 1,
        rate: 5.38,
        remark: "可以当枕头的好东西",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 5.38,
        initialRemark: "可以当枕头的好东西",
        hasInitialState: true
    },
    {
        id: 1768529950709,
        name: "可爱猫猫爪",
        quantity: 1,
        remaining: 1,
        rate: 4.33,
        remark: "可以吱吱叫",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 4.33,
        initialRemark: "可以吱吱叫",
        hasInitialState: true
    },
    {
        id: 1768530021613,
        name: "宕机发夹",
        quantity: 1,
        remaining: 1,
        rate: 15,
        remark: "……",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 15,
        initialRemark: "……",
        hasInitialState: true
    },
    {
        id: 1768530072973,
        name: "高端杯具",
        quantity: 1,
        remaining: 1,
        rate: 12,
        remark: "奢侈",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 12,
        initialRemark: "奢侈",
        hasInitialState: true
    },
    {
        id: 1768530202941,
        name: "可随意摆弄的人形模型",
        quantity: 1,
        remaining: 1,
        rate: 12,
        remark: "HiaHiaHia~",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 12,
        initialRemark: "HiaHiaHia~",
        hasInitialState: true
    },
    {
        id: 1768530226741,
        name: "捣蛋钥匙孔",
        quantity: 1,
        remaining: 1,
        rate: 8.35,
        remark: "好玩~",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 8.35,
        initialRemark: "好玩~",
        hasInitialState: true
    },
    {
        id: 1768530242093,
        name: "路障僵尸同款精致帽子",
        quantity: 1,
        remaining: 1,
        rate: 10.34,
        remark: "兼备防雨防阳功能",
        initialQuantity: 1,
        initialRemaining: 1,
        initialRate: 10.34,
        initialRemark: "兼备防雨防阳功能",
        hasInitialState: true
    },
    {
        id: 1768530788462,
        name: "谢谢参与",
        quantity: 5,
        remaining: 5,
        rate: 10.45,
        remark: "您抽到了新年祝福",
        initialQuantity: 5,
        initialRemaining: 5,
        initialRate: 10.45,
        initialRemark: "您抽到了新年祝福",
        hasInitialState: true
    }
],
                whitelist: [],
                records: [],
                currentUser: ''
            },

            // 初始化数据（兼容旧奖品无初始状态字段）
            init() {
                const localData = localStorage.getItem('qqLotteryData');
                if (localData) {
                    this.data = JSON.parse(localData);
                    // 为旧奖品补充初始状态字段（默认当前配置为初始状态）
                    this.data.prizes.forEach(prize => {
                        if (!prize.hasInitialState) {
                            prize.initialQuantity = prize.quantity;
                            prize.initialRemaining = prize.remaining;
                            prize.initialRate = prize.rate;
                            prize.initialRemark = prize.remark || '';
                            prize.hasInitialState = false; // 标记为“未主动设置”，需用户手动确认
                        }
                    });
                }
                // 确保settings存在
                if (!this.data.settings) this.data.settings = {whitelistMaxDraws: 1};
                this.saveData();
                this.updateAllUI();
            },

            // 保存数据到本地
            saveData() {
                localStorage.setItem('qqLotteryData', JSON.stringify(this.data));
            },

            // ------------------------------
            // 新增：设置奖品初始状态
            // ------------------------------
            setPrizeInitialState(prizeId) {
                const prizeIndex = this.data.prizes.findIndex(prize => prize.id === prizeId);
                if (prizeIndex === -1) return false;
                
                const currentPrize = this.data.prizes[prizeIndex];
                // 将当前配置保存为初始状态
                currentPrize.initialQuantity = currentPrize.quantity;
                currentPrize.initialRemaining = currentPrize.remaining;
                currentPrize.initialRate = currentPrize.rate;
                currentPrize.initialRemark = currentPrize.remark || '';
                currentPrize.hasInitialState = true; // 标记为已设置
                
                this.saveData();
                return true;
            },

            // ------------------------------
            // 新增：重置奖品到初始状态
            // ------------------------------
            resetPrizeToInitial(prizeId) {
                const prizeIndex = this.data.prizes.findIndex(prize => prize.id === prizeId);
                if (prizeIndex === -1) return false;
                
                const currentPrize = this.data.prizes[prizeIndex];
                // 检查是否已设置初始状态
                if (!currentPrize.hasInitialState) return false;
                
                // 恢复到初始状态
                currentPrize.quantity = currentPrize.initialQuantity;
                currentPrize.remaining = currentPrize.initialRemaining;
                currentPrize.rate = currentPrize.initialRate;
                currentPrize.remark = currentPrize.initialRemark;
                
                this.saveData();
                return true;
            },

            // 管理员登录验证
            checkAdminPwd(pwd) {
                return pwd === this.data.adminPwd;
            },

            // 修改管理员密码
            changeAdminPwd(newPwd) {
                this.data.adminPwd = newPwd;
                this.saveData();
                return true;
            },

            // 设置白名单用户最大抽奖次数
            setWhitelistMaxDraws(count) {
                const maxCount = Math.min(Math.max(1, count), 10); // 限制1~10次
                this.data.settings.whitelistMaxDraws = maxCount;
                this.saveData();
                return maxCount;
            },

            // 白名单开关
            toggleWhitelist(enabled) {
                this.data.whitelistEnabled = enabled;
                this.saveData();
                return true;
            },

            // 统计用户已抽奖次数
            getUserDrawCount(userName) {
                return this.data.records.filter(item => item.user === userName).length;
            },

            // 检查用户是否可抽奖（次数限制）
            checkUserCanDraw(userName) {
                // 白名单禁用：非白名单用户可抽1次
                if (!this.data.whitelistEnabled) {
                    const drawCount = this.getUserDrawCount(userName);
                    return drawCount < 1;
                }
                // 白名单启用：仅白名单用户可抽，且不超过最大次数
                const isInWhitelist = this.data.whitelist.some(item => item.name === userName);
                if (!isInWhitelist) return false;
                const drawCount = this.getUserDrawCount(userName);
                return drawCount < this.data.settings.whitelistMaxDraws;
            },

            // 获取用户剩余抽奖次数
            getUserRemainingDraws(userName) {
                if (!this.data.whitelistEnabled) {
                    return Math.max(0, 1 - this.getUserDrawCount(userName));
                }
                const isInWhitelist = this.data.whitelist.some(item => item.name === userName);
                if (!isInWhitelist) return 0;
                return Math.max(0, this.data.settings.whitelistMaxDraws - this.getUserDrawCount(userName));
            },

            // 检查用户是否在白名单
            checkWhitelist(name) {
                if (!this.data.whitelistEnabled) return true;
                return this.data.whitelist.some(item => item.name === name);
            },

            // 添加白名单用户
            addWhitelistUser(name) {
                if (this.data.whitelist.some(item => item.name === name)) return false;
                this.data.whitelist.push({
                    name,
                    time: new Date().toLocaleString()
                });
                this.saveData();
                return true;
            },

            // 删除白名单用户
            deleteWhitelistUser(name) {
                const oldLength = this.data.whitelist.length;
                this.data.whitelist = this.data.whitelist.filter(item => item.name !== name);
                this.saveData();
                return this.data.whitelist.length < oldLength;
            },

            // 添加奖品
            addPrize(name, num, rate, remark = '') {
                const newPrize = {
                    id: Date.now(),
                    name,
                    quantity: num,
                    remaining: num,
                    rate: num > 0 ? rate : 0, // 数量为0时概率设为0
                    remark,
                    // 新增：默认初始状态为当前配置，但标记为“未主动设置”
                    initialQuantity: num,
                    initialRemaining: num,
                    initialRate: num > 0 ? rate : 0,
                    initialRemark: remark,
                    hasInitialState: false
                };
                this.data.prizes.push(newPrize);
                this.saveData();
                return newPrize;
            },

            // 编辑奖品
            editPrize(id, data) {
                const prizeIndex = this.data.prizes.findIndex(item => item.id === id);
                if (prizeIndex === -1) return false;
                // 数据验证
                const quantity = Math.max(1, parseInt(data.quantity));
                const remaining = Math.min(Math.max(0, parseInt(data.remaining)), quantity);
                const rate = remaining > 0 ? Math.max(0, Math.min(100, parseFloat(data.rate))) : 0;
                // 更新奖品
                this.data.prizes[prizeIndex] = {
                    ...this.data.prizes[prizeIndex],
                    name: data.name,
                    quantity,
                    remaining,
                    rate,
                    remark: data.remark || ''
                };
                this.saveData();
                return true;
            },

            // 删除奖品
            deletePrize(id) {
                const oldLength = this.data.prizes.length;
                this.data.prizes = this.data.prizes.filter(item => item.id !== id);
                this.saveData();
                return this.data.prizes.length < oldLength;
            },

            // 执行抽奖
            doLottery(name) {
                // 检查白名单
                if (!this.checkWhitelist(name)) {
                    return {success: false, msg: '您不在白名单中，无法参与抽奖'};
                }
                // 检查抽奖次数
                if (!this.checkUserCanDraw(name)) {
                    const maxDraws = this.data.whitelistEnabled ? this.data.settings.whitelistMaxDraws : 1;
                    return {success: false, msg: `您已达到最大抽奖次数（${maxDraws}次）`};
                }
                // 检查奖品是否充足
                const availablePrizes = this.data.prizes.filter(item => item.remaining > 0);
                if (availablePrizes.length === 0) {
                    return {success: false, msg: '所有奖品已抽完'};
                }

                // 按概率抽奖
                let totalRate = 0;
                availablePrizes.forEach(item => totalRate += item.rate);
                let random = Math.random() * totalRate;
                let winPrize = null;

                for (const prize of availablePrizes) {
                    random -= prize.rate;
                    if (random <= 0) {
                        winPrize = prize;
                        break;
                    }
                }

                // 更新奖品剩余数量和概率（剩余为0时概率设为0）
                winPrize.remaining -= 1;
                if (winPrize.remaining === 0) {
                    winPrize.rate = 0; // 实时设为0
                }

                // 记录抽奖结果
                const record = {
                    user: name,
                    prize: winPrize.name,
                    time: new Date().toLocaleString()
                };
                this.data.records.push(record);
                this.saveData();

                return {
                    success: true,
                    prize: winPrize.name,
                    record,
                    remainingDraws: this.getUserRemainingDraws(name)
                };
            },

            // 导出抽奖记录
            exportRecords() {
                let csv = '用户名,抽中奖品,抽奖时间\n';
                this.data.records.forEach((item, index) => {
                    csv += `${item.user},${item.prize},${item.time}\n`;
                });
                return csv;
            },

            // 清除所有抽奖记录
            clearLotteryRecords() {
                this.data.records = []; // 仅清空抽奖记录数组
                this.saveData();
                return true;
            },

            // 更新所有UI
            updateAllUI() {
                this.updateAdminUI();
                this.updateUserUI();
            },

            // 更新管理员UI
            updateAdminUI() {
                // 控制面板数据
                const totalPrizes = this.data.prizes.reduce((sum, item) => sum + item.quantity, 0);
                const leftPrizes = this.data.prizes.reduce((sum, item) => sum + item.remaining, 0);
                const totalDraws = this.data.records.length;
                document.getElementById('admin-total-prizes').textContent = totalPrizes;
                document.getElementById('admin-total-draws').textContent = totalDraws;
                document.getElementById('admin-left-prizes').textContent = leftPrizes;

                // 系统设置回显
                document.getElementById('whitelist-switch').checked = this.data.whitelistEnabled;
                document.getElementById('whitelist-max-draws').value = this.data.settings.whitelistMaxDraws;

                // 奖品表格（新增“初始状态”列和双按钮）
                const prizeTable = document.getElementById('prize-table');
                prizeTable.innerHTML = '';
                this.data.prizes.forEach((item, index) => {
                    const isOut = item.remaining === 0;
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index+1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.remaining}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.rate.toFixed(2)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${item.hasInitialState ? 
                              '<span class="badge badge-initial">已设置</span>' : 
                              '<span class="badge bg-gray-100 text-gray-500">未设置</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">${item.remark || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-prize text-primary hover:text-primary/80 mr-2" data-id="${item.id}">编辑</button>
                            <button class="set-initial-state btn-secondary py-1 px-2 text-xs mr-2" data-id="${item.id}">设初始状态</button>
                            <button class="reset-prize btn-warning py-1 px-2 text-xs" data-id="${item.id}" ${!item.hasInitialState ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>重置</button>
                            <button class="delete-prize text-danger hover:text-danger/80 ml-2" data-id="${item.id}">删除</button>
                        </td>
                    `;
                    prizeTable.appendChild(tr);
                });

                // 白名单表格
                const whitelistTable = document.getElementById('whitelist-table');
                whitelistTable.innerHTML = '';
                this.data.whitelist.forEach((item, index) => {
                    const drawCount = this.getUserDrawCount(item.name);
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index+1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${drawCount}/${this.data.settings.whitelistMaxDraws}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="delete-whitelist text-danger hover:text-danger/80" data-name="${item.name}">删除</button>
                        </td>
                    `;
                    whitelistTable.appendChild(tr);
                });

                // 抽奖记录表格
                const recordTable = document.getElementById('record-table');
                recordTable.innerHTML = '';
                if (this.data.records.length === 0) {
                    // 无记录时显示空提示
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="4" class="px-6 py-8 text-center text-sm text-gray-500">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p>暂无抽奖记录</p>
                        </td>
                    `;
                    recordTable.appendChild(tr);
                } else {
                    this.data.records.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index+1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.user}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.prize}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.time}</td>
                        `;
                        recordTable.appendChild(tr);
                    });
                }
            },

            // 更新用户UI
            updateUserUI() {
                // 概览数据
                const totalPrizes = this.data.prizes.reduce((sum, item) => sum + item.quantity, 0);
                const leftPrizes = this.data.prizes.reduce((sum, item) => sum + item.remaining, 0);
                const totalDraws = this.data.records.length;
                document.getElementById('user-total-prizes').textContent = totalPrizes;
                document.getElementById('user-total-draws').textContent = totalDraws;
                document.getElementById('user-left-prizes').textContent = leftPrizes;

                // 当前用户信息
                if (this.data.currentUser) {
                    const userName = this.data.currentUser;
                    const canDraw = this.checkUserCanDraw(userName);
                    const drawCount = this.getUserDrawCount(userName);
                    const remainingDraws = this.getUserRemainingDraws(userName);
                    const maxDraws = this.data.whitelistEnabled ? this.data.settings.whitelistMaxDraws : 1;

                    document.getElementById('current-user').textContent = userName;
                    document.getElementById('remaining-draws').innerHTML = `剩余抽奖次数：<span class="text-primary font-medium">${remainingDraws}次</span>`;
                    
                    if (canDraw) {
                        document.getElementById('lottery-status').textContent = `您可参与抽奖（已抽${drawCount}次，共${maxDraws}次机会）`;
                        document.getElementById('start-lottery').disabled = false;
                        document.getElementById('start-lottery').className = 'btn-primary text-xl py-6 px-12';
                        document.getElementById('start-lottery').innerHTML = '<i class="fas fa-gift mr-3"></i>开始抽奖';
                    } else {
                        document.getElementById('lottery-status').textContent = `您已完成所有抽奖（共${maxDraws}次）`;
                        document.getElementById('start-lottery').disabled = true;
                        document.getElementById('start-lottery').className = 'btn-disabled text-xl py-6 px-12';
                        document.getElementById('start-lottery').innerHTML = '<i class="fas fa-check mr-3"></i>已抽完所有次数';
                    }
                }

                // 奖品列表
                const prizeList = document.getElementById('user-prize-list');
                prizeList.innerHTML = '';
                this.data.prizes.forEach(item => {
                    const isOut = item.remaining === 0;
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-4 border border-gray-100';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800">${item.name}</h3>
                            ${isOut ? '<span class="badge badge-out text-xs">已抽完</span>' : ''}
                        </div>
                        <p class="text-gray-600 text-sm mt-1">剩余：${item.remaining}/${item.quantity}</p>
                        <p class="text-primary text-sm mt-1">概率：${item.rate.toFixed(2)}%</p>
                        ${item.remark ? `<p class="text-gray-500 text-xs mt-1">备注：${item.remark}</p>` : ''}
                    `;
                    prizeList.appendChild(card);
                });
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化核心逻辑
            LotteryCore.init();

            // 隐藏加载动画
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 300);
            }, 500);

            // 显示系统提示
            function showAlert(msg, type = 'info') {
                const alertEl = document.getElementById('system-alert');
                const msgEl = document.getElementById('alert-message');
                alertEl.classList.remove('hidden');
                msgEl.textContent = msg;
                if (type === 'error') {
                    alertEl.className = 'mb-8 p-4 rounded-lg bg-danger/10 border border-danger/20';
                    msgEl.className = 'text-danger';
                } else if (type === 'success') {
                    alertEl.className = 'mb-8 p-4 rounded-lg bg-success/10 border border-success/20';
                    msgEl.className = 'text-success';
                } else {
                    alertEl.className = 'mb-8 p-4 rounded-lg bg-primary/10 border border-primary/20';
                    msgEl.className = 'text-gray-700';
                }
                setTimeout(() => {
                    alertEl.classList.add('hidden');
                }, 3000);
            }

            // ------------------------------
            // 1. “设置初始状态”按钮交互
            // ------------------------------
            document.addEventListener('click', (e) => {
                if (e.target.closest('.set-initial-state')) {
                    const btn = e.target.closest('.set-initial-state');
                    const prizeId = parseInt(btn.getAttribute('data-id'));
                    const success = LotteryCore.setPrizeInitialState(prizeId);
                    if (success) {
                        showAlert('奖品初始状态设置成功', 'success');
                        LotteryCore.updateAllUI();
                    } else {
                        showAlert('设置初始状态失败，请重试', 'error');
                    }
                }
            });

            // ------------------------------
            // 2. “重置”按钮交互（含确认弹窗）
            // ------------------------------
            const resetPrizeConfirmModal = document.getElementById('reset-prize-confirm-modal');
            const resetPrizeIdInput = document.getElementById('reset-prize-id');
            const cancelResetPrizeBtn = document.getElementById('cancel-reset-prize');
            const confirmResetPrizeBtn = document.getElementById('confirm-reset-prize');

            // 点击重置按钮，显示确认弹窗
            document.addEventListener('click', (e) => {
                if (e.target.closest('.reset-prize') && !e.target.closest('.reset-prize').disabled) {
                    const btn = e.target.closest('.reset-prize');
                    const prizeId = parseInt(btn.getAttribute('data-id'));
                    resetPrizeIdInput.value = prizeId;
                    resetPrizeConfirmModal.classList.remove('hidden');
                }
            });

            // 取消重置
            cancelResetPrizeBtn.addEventListener('click', () => {
                resetPrizeConfirmModal.classList.add('hidden');
            });

            // 确认重置
            confirmResetPrizeBtn.addEventListener('click', () => {
                const prizeId = parseInt(resetPrizeIdInput.value);
                const success = LotteryCore.resetPrizeToInitial(prizeId);
                if (success) {
                    showAlert('奖品已重置到初始状态', 'success');
                    LotteryCore.updateAllUI();
                } else {
                    showAlert('重置失败，请先设置初始状态', 'error');
                }
                resetPrizeConfirmModal.classList.add('hidden');
            });

            // 用户菜单下拉
            const userMenuBtn = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');
            userMenuBtn.addEventListener('click', () => {
                userDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });

            // 管理员登录
            const adminLoginBtn = document.getElementById('admin-login');
            const loginModal = document.getElementById('login-modal');
            const doLoginBtn = document.getElementById('do-login');
            const closeLoginBtn = document.getElementById('close-login');
            const loginPwd = document.getElementById('login-pwd');
            const loginError = document.getElementById('login-error');

            adminLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.classList.remove('hidden');
                loginPwd.value = '';
                loginError.classList.add('hidden');
            });

            closeLoginBtn.addEventListener('click', () => {
                loginModal.classList.add('hidden');
            });

            doLoginBtn.addEventListener('click', () => {
                const pwd = loginPwd.value.trim();
                if (!pwd) {
                    loginError.textContent = '请输入密码';
                    loginError.classList.remove('hidden');
                    return;
                }
                if (LotteryCore.checkAdminPwd(pwd)) {
                    loginModal.classList.add('hidden');
                    document.getElementById('user-view').classList.add('hidden');
                    document.getElementById('admin-view').classList.remove('hidden');
                    document.getElementById('user-role').textContent = '管理员';
                    LotteryCore.updateAdminUI();
                } else {
                    loginError.textContent = '密码错误，请重试';
                    loginError.classList.remove('hidden');
                }
            });

            // 退出登录（返回用户视图）
            const logoutBtn = document.getElementById('logout');
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('admin-view').classList.add('hidden');
                document.getElementById('user-view').classList.remove('hidden');
                document.getElementById('user-role').textContent = '访客';
                LotteryCore.data.currentUser = '';
                LotteryCore.saveData();
                LotteryCore.updateUserUI();
                document.getElementById('user-input-form').classList.remove('hidden');
                document.getElementById('lottery-area').classList.add('hidden');
            });

            // 修改管理员密码
            const savePwdBtn = document.getElementById('save-pwd');
            const adminPwd = document.getElementById('admin-pwd');
            savePwdBtn.addEventListener('click', () => {
                const newPwd = adminPwd.value.trim();
                if (!newPwd) {
                    showAlert('请输入新密码', 'error');
                    return;
                }
                LotteryCore.changeAdminPwd(newPwd);
                adminPwd.value = '';
                showAlert('管理员密码修改成功', 'success');
            });

            // 设置白名单用户最大抽奖次数
            const saveMaxDrawsBtn = document.getElementById('save-max-draws');
            const whitelistMaxDraws = document.getElementById('whitelist-max-draws');
            saveMaxDrawsBtn.addEventListener('click', () => {
                const count = parseInt(whitelistMaxDraws.value);
                if (isNaN(count)) {
                    showAlert('请输入有效数字', 'error');
                    return;
                }
                const actualCount = LotteryCore.setWhitelistMaxDraws(count);
                whitelistMaxDraws.value = actualCount;
                showAlert(`白名单用户最大抽奖次数已设为${actualCount}次`, 'success');
                LotteryCore.updateAllUI();
            });

            // 白名单开关
            const whitelistSwitch = document.getElementById('whitelist-switch');
            whitelistSwitch.addEventListener('change', () => {
                LotteryCore.toggleWhitelist(whitelistSwitch.checked);
                showAlert(`白名单功能已${whitelistSwitch.checked ? '启用' : '禁用'}`, 'success');
                LotteryCore.updateAllUI();
            });

            // 添加奖品
            const addPrizeBtn = document.getElementById('add-prize');
            const addPrizeModal = document.getElementById('add-prize-modal');
            const savePrizeBtn = document.getElementById('save-prize');
            const closePrizeModal = document.getElementById('close-prize-modal');
            const newPrizeName = document.getElementById('new-prize-name');
            const newPrizeNum = document.getElementById('new-prize-num');
            const newPrizeRate = document.getElementById('new-prize-rate');
            const newPrizeRemark = document.getElementById('new-prize-remark');

            addPrizeBtn.addEventListener('click', () => {
                addPrizeModal.classList.remove('hidden');
                newPrizeName.value = '';
                newPrizeNum.value = 1;
                newPrizeRate.value = '';
                newPrizeRemark.value = '';
            });

            closePrizeModal.addEventListener('click', () => {
                addPrizeModal.classList.add('hidden');
            });

            savePrizeBtn.addEventListener('click', () => {
                const name = newPrizeName.value.trim();
                const num = parseInt(newPrizeNum.value);
                const rate = parseFloat(newPrizeRate.value);
                const remark = newPrizeRemark.value.trim();

                if (!name || isNaN(num) || isNaN(rate) || rate < 0 || rate > 100) {
                    showAlert('请填写正确的奖品信息（名称必填，数量≥1，概率0-100%）', 'error');
                    return;
                }

                LotteryCore.addPrize(name, num, rate, remark);
                addPrizeModal.classList.add('hidden');
                showAlert('奖品添加成功', 'success');
                LotteryCore.updateAllUI();
            });

            // 编辑奖品
            const editPrizeModal = document.getElementById('edit-prize-modal');
            const updatePrizeBtn = document.getElementById('update-prize');
            const closeEditModal = document.getElementById('close-edit-modal');
            const editPrizeId = document.getElementById('edit-prize-id');
            const editPrizeName = document.getElementById('edit-prize-name');
            const editPrizeNum = document.getElementById('edit-prize-num');
            const editPrizeLeft = document.getElementById('edit-prize-left');
            const editPrizeRate = document.getElementById('edit-prize-rate');
            const editPrizeRemark = document.getElementById('edit-prize-remark');
            const editError = document.getElementById('edit-error');

            // 编辑按钮点击事件
            document.addEventListener('click', (e) => {
                if (e.target.closest('.edit-prize')) {
                    const btn = e.target.closest('.edit-prize');
                    const prizeId = parseInt(btn.getAttribute('data-id'));
                    const prize = LotteryCore.data.prizes.find(item => item.id === prizeId);
                    if (!prize) return;

                    // 回显数据到模态框
                    editPrizeId.value = prize.id;
                    editPrizeName.value = prize.name;
                    editPrizeNum.value = prize.quantity;
                    editPrizeLeft.value = prize.remaining;
                    editPrizeRate.value = prize.rate;
                    editPrizeRemark.value = prize.remark || '';
                    editError.classList.add('hidden');

                    // 显示模态框
                    editPrizeModal.classList.remove('hidden');
                }
            });

            // 关闭编辑模态框
            closeEditModal.addEventListener('click', () => {
                editPrizeModal.classList.add('hidden');
            });

            // 保存编辑
            updatePrizeBtn.addEventListener('click', () => {
                const id = parseInt(editPrizeId.value);
                const name = editPrizeName.value.trim();
                const quantity = editPrizeNum.value;
                const remaining = editPrizeLeft.value;
                const rate = editPrizeRate.value;
                const remark = editPrizeRemark.value.trim();

                // 数据验证
                if (!name || isNaN(quantity) || isNaN(remaining) || isNaN(rate)) {
                    editError.textContent = '请填写所有必填项，且数量/概率为数字';
                    editError.classList.remove('hidden');
                    return;
                }
                if (parseInt(quantity) < 1 || parseInt(remaining) < 0 || parseInt(remaining) > parseInt(quantity)) {
                    editError.textContent = '总数量≥1，剩余数量≤总数量且≥0';
                    editError.classList.remove('hidden');
                    return;
                }
                if (parseFloat(rate) < 0 || parseFloat(rate) > 100) {
                    editError.textContent = '概率范围：0~100%';
                    editError.classList.remove('hidden');
                    return;
                }

                // 提交编辑
                const success = LotteryCore.editPrize(id, {
                    name,
                    quantity,
                    remaining,
                    rate,
                    remark
                });

                if (success) {
                    editPrizeModal.classList.add('hidden');
                    showAlert('奖品修改成功', 'success');
                    LotteryCore.updateAllUI();
                } else {
                    editError.textContent = '奖品不存在或修改失败';
                    editError.classList.remove('hidden');
                }
            });

            // 删除奖品
            document.addEventListener('click', (e) => {
                if (e.target.closest('.delete-prize')) {
                    const btn = e.target.closest('.delete-prize');
                    const prizeId = parseInt(btn.getAttribute('data-id'));
                    if (confirm('确定要删除这个奖品吗？删除后不可恢复')) {
                        const success = LotteryCore.deletePrize(prizeId);
                        if (success) {
                            showAlert('奖品删除成功', 'success');
                            LotteryCore.updateAllUI();
                        } else {
                            showAlert('奖品删除失败', 'error');
                        }
                    }
                }
            });

            // 添加白名单用户
            const addWhitelistBtn = document.getElementById('add-whitelist');
            const addWhitelistModal = document.getElementById('add-whitelist-modal');
            const saveWhitelistBtn = document.getElementById('save-whitelist');
            const closeWhitelistModal = document.getElementById('close-whitelist-modal');
            const newWhitelistName = document.getElementById('new-whitelist-name');

            addWhitelistBtn.addEventListener('click', () => {
                addWhitelistModal.classList.remove('hidden');
                newWhitelistName.value = '';
            });

            closeWhitelistModal.addEventListener('click', () => {
                addWhitelistModal.classList.add('hidden');
            });

            saveWhitelistBtn.addEventListener('click', () => {
                const name = newWhitelistName.value.trim();
                if (!name) {
                    showAlert('请输入用户名（QQ昵称）', 'error');
                    return;
                }
                const result = LotteryCore.addWhitelistUser(name);
                if (!result) {
                    showAlert('该用户已在白名单中', 'error');
                    return;
                }
                addWhitelistModal.classList.add('hidden');
                showAlert('白名单用户添加成功', 'success');
                LotteryCore.updateAllUI();
            });

            // 删除白名单用户
            document.addEventListener('click', (e) => {
                if (e.target.closest('.delete-whitelist')) {
                    const btn = e.target.closest('.delete-whitelist');
                    const name = btn.getAttribute('data-name');
                    if (confirm(`确定要删除白名单用户"${name}"吗？`)) {
                        const success = LotteryCore.deleteWhitelistUser(name);
                        if (success) {
                            showAlert('白名单用户删除成功', 'success');
                            LotteryCore.updateAllUI();
                        } else {
                            showAlert('白名单用户删除失败', 'error');
                        }
                    }
                }
            });

            // 导出抽奖记录
            const exportRecordBtn = document.getElementById('export-record');
            exportRecordBtn.addEventListener('click', () => {
                const csv = LotteryCore.exportRecords();
                if (!csv) {
                    showAlert('暂无抽奖记录', 'error');
                    return;
                }
                const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', `QQ群抽奖记录_${new Date().toLocaleDateString()}.csv`);
                a.style.visibility = 'hidden';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showAlert('抽奖记录导出成功', 'success');
            });

            // 清除抽奖记录
            const clearRecordBtn = document.getElementById('clear-record');
            const clearConfirmModal = document.getElementById('clear-confirm-modal');
            const cancelClearBtn = document.getElementById('cancel-clear');
            const confirmClearBtn = document.getElementById('confirm-clear');

            // 点击清除按钮，显示确认模态框
            clearRecordBtn.addEventListener('click', () => {
                clearConfirmModal.classList.remove('hidden');
            });

            // 取消清除
            cancelClearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.add('hidden');
            });

            // 确认清除
            confirmClearBtn.addEventListener('click', () => {
                const success = LotteryCore.clearLotteryRecords();
                if (success) {
                    showAlert('所有抽奖记录已清除', 'success');
                    LotteryCore.updateAllUI(); // 刷新表格和统计数据
                } else {
                    showAlert('清除记录失败，请重试', 'error');
                }
                clearConfirmModal.classList.add('hidden');
            });

            // 用户输入用户名
            const submitNameBtn = document.getElementById('submit-name');
            const userNameInput = document.getElementById('user-name');
            const userInputForm = document.getElementById('user-input-form');
            const lotteryArea = document.getElementById('lottery-area');

            submitNameBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                if (!name) {
                    showAlert('请输入您的QQ昵称', 'error');
                    return;
                }

                // 检查白名单
                if (!LotteryCore.checkWhitelist(name)) {
                    showAlert('您不在白名单中，无法参与抽奖', 'error');
                    return;
                }

                // 保存当前用户
                LotteryCore.data.currentUser = name;
                LotteryCore.saveData();
                LotteryCore.updateUserUI();

                // 切换显示（隐藏输入框，显示抽奖区）
                userInputForm.classList.add('hidden');
                lotteryArea.classList.remove('hidden');
                document.getElementById('current-user').textContent = name;
            });

            // 切换用户
            const resetUserBtn = document.getElementById('reset-user');
            resetUserBtn.addEventListener('click', () => {
                LotteryCore.data.currentUser = '';
                LotteryCore.saveData();
                userInputForm.classList.remove('hidden');
                lotteryArea.classList.add('hidden');
                userNameInput.value = '';
            });

            // 开始抽奖
            const startLotteryBtn = document.getElementById('start-lottery');
            const lotteryResult = document.getElementById('lottery-result');
            const winPrize = document.getElementById('win-prize');
            const drawsRemainingAfter = document.getElementById('draws-remaining-after');
            const closeResultBtn = document.getElementById('close-result');

            startLotteryBtn.addEventListener('click', () => {
                const userName = LotteryCore.data.currentUser;
                if (!userName) {
                    showAlert('请先输入用户名', 'error');
                    return;
                }

                // 执行抽奖
                const result = LotteryCore.doLottery(userName);
                if (!result.success) {
                    showAlert(result.msg, 'error');
                    return;
                }

                // 显示抽奖结果
                winPrize.textContent = result.prize;
                drawsRemainingAfter.innerHTML = `剩余抽奖次数：<span class="text-primary font-medium">${result.remainingDraws}次</span>`;
                lotteryResult.classList.remove('hidden');

                // 更新UI
                LotteryCore.updateAllUI();
            });

            // 关闭抽奖结果弹窗
            closeResultBtn.addEventListener('click', () => {
                lotteryResult.classList.add('hidden');
            });
        });
    </script>
</body>

</html>

